#!/bin/bash

source _common.sh
source /usr/share/yunohost/helpers

ynh_app_setting_set_default --key=php_upload_max_filesize --value=256M

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression "Upgrading source files..."

ynh_setup_source --dest_dir="$install_dir/git_src"

ynh_safe_rm $install_dir/www/install

find $install_dir/www -type d -exec chmod 755 {} \;
find $install_dir/www -type f -exec chmod 644 {} \;

ynh_safe_rm "$install_dir/www/public_html"
ln -s $install_dir/git_src/public_html $install_dir/www

#=================================================
# UPDATE A CONFIG FILE
#=================================================
ynh_script_progression "Updating $app's configuration files..."

ynh_config_add_phpfpm

ynh_config_add_nginx

#=================================================
# UPGRADE MYSQL CONFIGURATION
#=================================================
ynh_script_progression "Upgrading MySQL configuration..."

# Update MySQL entries
upgrade_mysql_dir="../patches/mysql/from_$src_version.sql"

if [ -f "$upgrade_mysql_dir" ]; then
	ynh_mysql_db_shell  < "$upgrade_mysql_dir"
	cat $upgrade_mysql_dir
fi

updated_src_version=$(ynh_app_upstream_version)
ynh_app_setting_set --key=src_version --value=$updated_src_version

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Upgrade of $app completed"
